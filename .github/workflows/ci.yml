name: CI Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-etl:
    runs-on: ubuntu-latest
    env:
      BUCKET_NAME: etl-demo-bucket
      RAW_KEY: raw/raw_data.csv
      PROCESSED_KEY: processed/processed_data.csv
      LOCALSTACK_ENDPOINT: http://localstack:4566

    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        options: >-
          --health-cmd "curl -f http://localhost:4566/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Wait for LocalStack
        run: |
          echo "Waiting for LocalStack to be healthy..."
          until curl -s $LOCALSTACK_ENDPOINT/health | grep "running"; do
            sleep 5
          done

      - name: Run ETL container
        run: |
          docker run \
            -e BUCKET_NAME=${BUCKET_NAME} \
            -e RAW_KEY=${RAW_KEY} \
            -e PROCESSED_KEY=${PROCESSED_KEY} \
            -e LOCALSTACK_ENDPOINT=${LOCALSTACK_ENDPOINT} \
            --network ${{ job.services.localstack.network }} \
            etl-image:latest

      - name: Verify ETL output
        run: |
          echo "Checking if processed file exists in LocalStack..."
          docker run --rm \
            -e BUCKET_NAME=${BUCKET_NAME} \
            -e PROCESSED_KEY=${PROCESSED_KEY} \
            -e LOCALSTACK_ENDPOINT=${LOCALSTACK_ENDPOINT} \
            etl-image:latest \
            sh -c 'if ! aws --endpoint-url=$LOCALSTACK_ENDPOINT s3 ls s3://$BUCKET_NAME/$PROCESSED_KEY; then echo "ETL output missing!" && exit 1; fi'
